---
uid: web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
title: Uso de dependências de Cache SQL (c#) | Microsoft Docs
author: rick-anderson
description: A estratégia de cache mais simples é permitir que os dados armazenados em cache expirar após um período de tempo especificado. Mas essa abordagem simples significa que os dados armazenados em cache maintai...
ms.author: aspnetcontent
manager: wpickett
ms.date: 05/30/2007
ms.topic: article
ms.assetid: 0e91842c-7f10-4aed-8c23-4ee3e2774014
ms.technology: dotnet-webforms
msc.legacyurl: /web-forms/overview/data-access/caching-data/using-sql-cache-dependencies-cs
msc.type: authoredcontent
ms.openlocfilehash: 16766ce7d741a9bcaea7cc676ed87978ea9f9f68
ms.sourcegitcommit: 953ff9ea4369f154d6fd0239599279ddd3280009
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/03/2018
ms.locfileid: "37385898"
---
<a name="using-sql-cache-dependencies-c"></a><span data-ttu-id="8976d-104">Uso de dependências de Cache SQL (c#)</span><span class="sxs-lookup"><span data-stu-id="8976d-104">Using SQL Cache Dependencies (C#)</span></span>
====================
<span data-ttu-id="8976d-105">por [Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="8976d-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="8976d-106">[Baixar o código](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip) ou [baixar PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="8976d-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_61_CS.zip) or [Download PDF](using-sql-cache-dependencies-cs/_static/datatutorial61cs1.pdf)</span></span>

> <span data-ttu-id="8976d-107">A estratégia de cache mais simples é permitir que os dados armazenados em cache expirar após um período de tempo especificado.</span><span class="sxs-lookup"><span data-stu-id="8976d-107">The simplest caching strategy is to allow cached data to expire after a specified period of time.</span></span> <span data-ttu-id="8976d-108">Mas essa abordagem simples significa que os dados em cache não mantém nenhuma associação com sua fonte de dados subjacente, resultando em dados obsoletos que são mantidos muito longos ou dados atuais que expiraram muito em breve.</span><span class="sxs-lookup"><span data-stu-id="8976d-108">But this simple approach means that the cached data maintains no association with its underlying data source, resulting in stale data that is held too long or current data that is expired too soon.</span></span> <span data-ttu-id="8976d-109">Uma abordagem melhor é usar a classe SqlCacheDependency para que os dados permanecem em cache até que seus dados base foi modificados no banco de dados SQL.</span><span class="sxs-lookup"><span data-stu-id="8976d-109">A better approach is to use the SqlCacheDependency class so that data remains cached until its underlying data has been modified in the SQL database.</span></span> <span data-ttu-id="8976d-110">Este tutorial mostra como fazer isso.</span><span class="sxs-lookup"><span data-stu-id="8976d-110">This tutorial shows you how.</span></span>


## <a name="introduction"></a><span data-ttu-id="8976d-111">Introdução</span><span class="sxs-lookup"><span data-stu-id="8976d-111">Introduction</span></span>

<span data-ttu-id="8976d-112">As técnicas de armazenamento em cache é examinado na [armazenando dados com o ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) e [dados em cache na arquitetura](caching-data-in-the-architecture-cs.md) tutoriais usado uma expiração com base no tempo para remover os dados do cache após um especificado período.</span><span class="sxs-lookup"><span data-stu-id="8976d-112">The caching techniques examined in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) and [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorials used a time-based expiry to evict the data from the cache after a specified period.</span></span> <span data-ttu-id="8976d-113">Essa abordagem é a maneira mais simples para equilibrar os ganhos de desempenho de armazenamento em cache em relação a desatualização limitada de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-113">This approach is the simplest way to balance the performance gains of caching against data staleness.</span></span> <span data-ttu-id="8976d-114">Selecionando uma expiração de tempo de *x* segundos, um desenvolvedor de página concedes para aproveitar os benefícios de desempenho de cache para apenas *x* segundos, mas pode ficar tranquilo que seus dados nunca serão obsoletos além do máximo dos *x* segundos.</span><span class="sxs-lookup"><span data-stu-id="8976d-114">By selecting a time expiry of *x* seconds, a page developer concedes to enjoy the performance benefits of caching for only *x* seconds, but can rest easy that her data will never be stale longer than a maximum of *x* seconds.</span></span> <span data-ttu-id="8976d-115">É claro que, para dados estáticos, *x* pode ser estendido para o tempo de vida do aplicativo web, como foi examinado na [armazenando dados na inicialização do aplicativo](caching-data-at-application-startup-cs.md) tutorial.</span><span class="sxs-lookup"><span data-stu-id="8976d-115">Of course, for static data, *x* can be extended to the lifetime of the web application, as was examined in the [Caching Data at Application Startup](caching-data-at-application-startup-cs.md) tutorial.</span></span>

<span data-ttu-id="8976d-116">Ao armazenar em cache de banco de dados, uma expiração com base no tempo geralmente é escolhida por sua facilidade de uso, mas com frequência é uma solução inadequada.</span><span class="sxs-lookup"><span data-stu-id="8976d-116">When caching database data, a time-based expiry is often chosen for its ease of use but is frequently an inadequate solution.</span></span> <span data-ttu-id="8976d-117">O ideal é que o banco de dados permanecerão armazenados em cache até que os dados subjacentes foi modificados no banco de dados; somente assim seria o cache ser removido.</span><span class="sxs-lookup"><span data-stu-id="8976d-117">Ideally, the database data would remain cached until the underlying data has been modified in the database; only then would the cache be evicted.</span></span> <span data-ttu-id="8976d-118">Essa abordagem maximiza os benefícios de desempenho de armazenamento em cache e minimiza a duração dos dados obsoletos.</span><span class="sxs-lookup"><span data-stu-id="8976d-118">This approach maximizes the performance benefits of caching and minimizes the duration of stale data.</span></span> <span data-ttu-id="8976d-119">No entanto, para aproveitar esses benefícios lá deve ser algum sistema em vigor que sabe quando o banco de dados subjacente foi modificado e remove os itens correspondentes do cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-119">However, in order to enjoy these benefits there must be some system in place that knows when the underlying database data has been modified and evicts the corresponding items from the cache.</span></span> <span data-ttu-id="8976d-120">Antes do ASP.NET 2.0, os desenvolvedores de páginas eram responsáveis por implementar esse sistema.</span><span class="sxs-lookup"><span data-stu-id="8976d-120">Prior to ASP.NET 2.0, page developers were responsible for implementing this system.</span></span>

<span data-ttu-id="8976d-121">O ASP.NET 2.0 oferece uma [ `SqlCacheDependency` classe](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) e a infraestrutura necessária para determinar quando uma alteração ocorreu no banco de dados para que os itens correspondentes em cache pode ser removida.</span><span class="sxs-lookup"><span data-stu-id="8976d-121">ASP.NET 2.0 provides a [`SqlCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.sqlcachedependency.aspx) and the necessary infrastructure to determine when a change has occurred in the database so that the corresponding cached items can be evicted.</span></span> <span data-ttu-id="8976d-122">Existem duas técnicas para determinar quando os dados subjacentes foi alterada: notificação e sondagem.</span><span class="sxs-lookup"><span data-stu-id="8976d-122">There are two techniques for determining when the underlying data has changed: notification and polling.</span></span> <span data-ttu-id="8976d-123">Após discutir as diferenças entre a sondagem e de notificação, vamos criar a infraestrutura necessária para dar suporte a sondagem e, em seguida, explorar como usar o `SqlCacheDependency` cenários classe declarativa e programaticamente.</span><span class="sxs-lookup"><span data-stu-id="8976d-123">After discussing the differences between notification and polling, we'll create the infrastructure necessary to support polling and then explore how to use the `SqlCacheDependency` class in declarative and programmatically scenarios.</span></span>

## <a name="understanding-notification-and-polling"></a><span data-ttu-id="8976d-124">Notificação de consulta e entendimento</span><span class="sxs-lookup"><span data-stu-id="8976d-124">Understanding Notification and Polling</span></span>

<span data-ttu-id="8976d-125">Há duas técnicas que podem ser usadas para determinar quando os dados em um banco de dados foi modificados: notificação e sondagem.</span><span class="sxs-lookup"><span data-stu-id="8976d-125">There are two techniques that can be used to determine when the data in a database has been modified: notification and polling.</span></span> <span data-ttu-id="8976d-126">Com a notificação, o banco de dados de alerta automaticamente o tempo de execução do ASP.NET quando os resultados de uma consulta específica tem sido alterados desde a consulta foi executada pela última vez, no ponto em que os itens em cache associados à consulta são removidos.</span><span class="sxs-lookup"><span data-stu-id="8976d-126">With notification, the database automatically alerts the ASP.NET runtime when the results of a particular query have been changed since the query was last executed, at which point the cached items associated with the query are evicted.</span></span> <span data-ttu-id="8976d-127">Com a sondagem, o servidor de banco de dados mantém informações sobre quando determinadas tabelas pela última vez foram atualizadas.</span><span class="sxs-lookup"><span data-stu-id="8976d-127">With polling, the database server maintains information about when particular tables have last been updated.</span></span> <span data-ttu-id="8976d-128">O tempo de execução do ASP.NET periodicamente sonda o banco de dados para verificar quais tabelas foram alteradas desde que eles foram inseridos no cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-128">The ASP.NET runtime periodically polls the database to check what tables have changed since they were entered into the cache.</span></span> <span data-ttu-id="8976d-129">As tabelas cujos dados foram modificados têm seus itens de cache associado removidos.</span><span class="sxs-lookup"><span data-stu-id="8976d-129">Those tables whose data has been modified have their associated cache items evicted.</span></span>

<span data-ttu-id="8976d-130">A opção de notificação requer uma configuração de menor que a sondagem e é mais granular, já que rastreiam as alterações no nível da consulta em vez de em nível de tabela.</span><span class="sxs-lookup"><span data-stu-id="8976d-130">The notification option requires less setup than polling and is more granular since it tracks changes at the query level rather than at the table level.</span></span> <span data-ttu-id="8976d-131">Infelizmente, as notificações só estão disponíveis nas edições completas do Microsoft SQL Server 2005 (ou seja, as edições não Express).</span><span class="sxs-lookup"><span data-stu-id="8976d-131">Unfortunately, notifications are only available in the full editions of Microsoft SQL Server 2005 (i.e., the non-Express editions).</span></span> <span data-ttu-id="8976d-132">No entanto, a opção de sondagem pode ser usada para todas as versões do Microsoft SQL Server do 7.0 para 2005.</span><span class="sxs-lookup"><span data-stu-id="8976d-132">However, the polling option can be used for all versions of Microsoft SQL Server from 7.0 to 2005.</span></span> <span data-ttu-id="8976d-133">Como esses tutoriais usam a edição Express do SQL Server 2005, vamos nos concentrar em como configurar e usar a opção de sondagem.</span><span class="sxs-lookup"><span data-stu-id="8976d-133">Since these tutorials use the Express edition of SQL Server 2005, we will focus on setting up and using the polling option.</span></span> <span data-ttu-id="8976d-134">Consulte a seção leitura adicional no final deste tutorial para obter mais recursos em recursos de notificação do SQL Server 2005 s.</span><span class="sxs-lookup"><span data-stu-id="8976d-134">Consult the Further Reading section at the end of this tutorial for further resources on SQL Server 2005 s notification capabilities.</span></span>

<span data-ttu-id="8976d-135">Com a sondagem, o banco de dados deve ser configurado para incluir uma tabela denominada `AspNet_SqlCacheTablesForChangeNotification` que tem três colunas - `tableName`, `notificationCreated`, e `changeId`.</span><span class="sxs-lookup"><span data-stu-id="8976d-135">With polling, the database must be configured to include a table named `AspNet_SqlCacheTablesForChangeNotification` that has three columns - `tableName`, `notificationCreated`, and `changeId`.</span></span> <span data-ttu-id="8976d-136">Esta tabela contém uma linha para cada tabela que tem dados que talvez precisem ser usados em uma dependência de cache SQL no aplicativo web.</span><span class="sxs-lookup"><span data-stu-id="8976d-136">This table contains a row for each table that has data that might need to be used in a SQL cache dependency in the web application.</span></span> <span data-ttu-id="8976d-137">O `tableName` coluna especifica o nome da tabela de enquanto `notificationCreated` indica a data e hora que a linha foi adicionada à tabela.</span><span class="sxs-lookup"><span data-stu-id="8976d-137">The `tableName` column specifies the name of the table while `notificationCreated` indicates the date and time the row was added to the table.</span></span> <span data-ttu-id="8976d-138">O `changeId` coluna é do tipo `int` e tem um valor inicial de 0.</span><span class="sxs-lookup"><span data-stu-id="8976d-138">The `changeId` column is of type `int` and has an initial value of 0.</span></span> <span data-ttu-id="8976d-139">Seu valor é incrementado a cada modificação à tabela.</span><span class="sxs-lookup"><span data-stu-id="8976d-139">Its value is incremented with each modification to the table.</span></span>

<span data-ttu-id="8976d-140">Além de `AspNet_SqlCacheTablesForChangeNotification` tabela, o banco de dados também precisa incluir gatilhos em cada uma das tabelas que podem aparecer em uma dependência de cache SQL.</span><span class="sxs-lookup"><span data-stu-id="8976d-140">In addition to the `AspNet_SqlCacheTablesForChangeNotification` table, the database also needs to include triggers on each of the tables that may appear in a SQL cache dependency.</span></span> <span data-ttu-id="8976d-141">Esses gatilhos são executados sempre que uma linha é inserida, atualizada ou excluída e incrementar a tabela s `changeId` valor em `AspNet_SqlCacheTablesForChangeNotification`.</span><span class="sxs-lookup"><span data-stu-id="8976d-141">These triggers are executed whenever a row is inserted, updated, or deleted and increment the table s `changeId` value in `AspNet_SqlCacheTablesForChangeNotification`.</span></span>

<span data-ttu-id="8976d-142">O tempo de execução do ASP.NET rastreia atual `changeId` para uma tabela ao armazenar em cache de dados usando um `SqlCacheDependency` objeto.</span><span class="sxs-lookup"><span data-stu-id="8976d-142">The ASP.NET runtime tracks the current `changeId` for a table when caching data using a `SqlCacheDependency` object.</span></span> <span data-ttu-id="8976d-143">O banco de dados é verificado periodicamente e qualquer `SqlCacheDependency` objetos cuja `changeId` difere do valor no banco de dados são removidos desde um diferindo `changeId` valor indica que houve uma alteração na tabela desde que foi armazenado em cache os dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-143">The database is periodically checked and any `SqlCacheDependency` objects whose `changeId` differs from the value in the database are evicted since a differing `changeId` value indicates that there has been a change to the table since the data was cached.</span></span>

## <a name="step-1-exploring-theaspnetregsqlexecommand-line-program"></a><span data-ttu-id="8976d-144">Etapa 1: Explorando o`aspnet_regsql.exe`programa de linha de comando</span><span class="sxs-lookup"><span data-stu-id="8976d-144">Step 1: Exploring the`aspnet_regsql.exe`Command Line Program</span></span>

<span data-ttu-id="8976d-145">Com a abordagem de sondagem, o banco de dados deve ser configurado para conter a infra-estrutura descrita acima: uma tabela predefinida (`AspNet_SqlCacheTablesForChangeNotification`), um punhado de procedimentos armazenados e gatilhos em cada uma das tabelas que podem ser usadas em dependências de cache SQL na web aplicativo.</span><span class="sxs-lookup"><span data-stu-id="8976d-145">With the polling approach the database must be setup to contain the infrastructure described above: a predefined table (`AspNet_SqlCacheTablesForChangeNotification`), a handful of stored procedures, and triggers on each of the tables that may be used in SQL cache dependencies in the web application.</span></span> <span data-ttu-id="8976d-146">Essas tabelas, procedimentos armazenados e gatilhos podem ser criados por meio do programa de linha de comando `aspnet_regsql.exe`, que é encontrado no `$WINDOWS$\Microsoft.NET\Framework\version` pasta.</span><span class="sxs-lookup"><span data-stu-id="8976d-146">These tables, stored procedures, and triggers can be created through the command line program `aspnet_regsql.exe`, which is found in the `$WINDOWS$\Microsoft.NET\Framework\version` folder.</span></span> <span data-ttu-id="8976d-147">Para criar o `AspNet_SqlCacheTablesForChangeNotification` tabela e procedimentos armazenados associados, executados o seguinte na linha de comando:</span><span class="sxs-lookup"><span data-stu-id="8976d-147">To create the `AspNet_SqlCacheTablesForChangeNotification` table and associated stored procedures, run the following from the command line:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample1.cmd)]

> [!NOTE]
> <span data-ttu-id="8976d-148">Para executar esses comandos que o logon de banco de dados especificado deve estar na [ `db_securityadmin` ](https://msdn.microsoft.com/library/ms188685.aspx) e [ `db_ddladmin` ](https://msdn.microsoft.com/library/ms190667.aspx) funções.</span><span class="sxs-lookup"><span data-stu-id="8976d-148">To execute these commands the specified database login must be in the [`db_securityadmin`](https://msdn.microsoft.com/library/ms188685.aspx) and [`db_ddladmin`](https://msdn.microsoft.com/library/ms190667.aspx) roles.</span></span> <span data-ttu-id="8976d-149">Para examinar o T-SQL enviado ao banco de dados pela `aspnet_regsql.exe` programa de linha de comando, consulte [essa entrada de blog](http://scottonwriting.net/sowblog/posts/10709.aspx).</span><span class="sxs-lookup"><span data-stu-id="8976d-149">To examine the T-SQL sent to the database by the `aspnet_regsql.exe` command line program, refer to [this blog entry](http://scottonwriting.net/sowblog/posts/10709.aspx).</span></span>


<span data-ttu-id="8976d-150">Por exemplo, para adicionar a infraestrutura para sondagem de um banco de dados do Microsoft SQL Server chamado `pubs` em um servidor de banco de dados denominado `ScottsServer` usando a autenticação do Windows, navegue até o diretório apropriado e, na linha de comando, digite:</span><span class="sxs-lookup"><span data-stu-id="8976d-150">For example, to add the infrastructure for polling to a Microsoft SQL Server database named `pubs` on a database server named `ScottsServer` using Windows Authentication, navigate to the appropriate directory and, from the command line, enter:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample2.cmd)]

<span data-ttu-id="8976d-151">Depois que a infraestrutura de nível de banco de dados tiver sido adicionada, precisamos adicionar os disparadores para as tabelas que serão usadas em dependências de cache SQL.</span><span class="sxs-lookup"><span data-stu-id="8976d-151">After the database-level infrastructure has been added, we need to add the triggers to those tables that will be used in SQL cache dependencies.</span></span> <span data-ttu-id="8976d-152">Usar o `aspnet_regsql.exe` linha de comando do programa novamente, mas especifique o nome de tabela usando o `-t` alternar e, em vez de usar o `-ed` alternar use `-et`, da seguinte forma:</span><span class="sxs-lookup"><span data-stu-id="8976d-152">Use the `aspnet_regsql.exe` command line program again, but specify the table name using the `-t` switch and instead of using the `-ed` switch use `-et`, like so:</span></span>


[!code-html[Main](using-sql-cache-dependencies-cs/samples/sample3.html)]

<span data-ttu-id="8976d-153">Para adicionar os gatilhos para o `authors` e `titles` tabelas na `pubs` banco de dados `ScottsServer`, use:</span><span class="sxs-lookup"><span data-stu-id="8976d-153">To add the triggers to the `authors` and `titles` tables on the `pubs` database on `ScottsServer`, use:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample4.cmd)]

<span data-ttu-id="8976d-154">Para este tutorial adicionará os gatilhos para o `Products`, `Categories`, e `Suppliers` tabelas.</span><span class="sxs-lookup"><span data-stu-id="8976d-154">For this tutorial add the triggers to the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="8976d-155">Vamos examinar a sintaxe de linha de comando específica na etapa 3.</span><span class="sxs-lookup"><span data-stu-id="8976d-155">We'll look at the particular command line syntax in Step 3.</span></span>

## <a name="step-2-referencing-a-microsoft-sql-server-2005-express-edition-database-inappdata"></a><span data-ttu-id="8976d-156">Etapa 2: Fazendo referência a um Microsoft SQL Server 2005 Express Edition Database em`App_Data`</span><span class="sxs-lookup"><span data-stu-id="8976d-156">Step 2: Referencing a Microsoft SQL Server 2005 Express Edition Database in`App_Data`</span></span>

<span data-ttu-id="8976d-157">O `aspnet_regsql.exe` programa de linha de comando requer o nome do banco de dados e servidor para adicionar a infraestrutura necessária de sondagem.</span><span class="sxs-lookup"><span data-stu-id="8976d-157">The `aspnet_regsql.exe` command line program requires the database and server name in order to add the necessary polling infrastructure.</span></span> <span data-ttu-id="8976d-158">Mas qual é o nome do banco de dados e servidor para um banco de dados Microsoft SQL Server 2005 Express que reside no `App_Data` pasta?</span><span class="sxs-lookup"><span data-stu-id="8976d-158">But what is the database and server name for a Microsoft SQL Server 2005 Express database that resides in the `App_Data` folder?</span></span> <span data-ttu-id="8976d-159">Em vez de precisar descobrir quais são os nomes de banco de dados e servidor, eu ve encontrado que a abordagem mais simples é anexar o banco de dados para o `localhost\SQLExpress` instância de banco de dados e renomeie os dados usando [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx).</span><span class="sxs-lookup"><span data-stu-id="8976d-159">Rather than having to discover what the database and server names are, I ve found that the simplest approach is to attach the database to the `localhost\SQLExpress` database instance and rename the data using [SQL Server Management Studio](https://msdn.microsoft.com/library/ms174173.aspx).</span></span> <span data-ttu-id="8976d-160">Se você tiver uma das versões completas do SQL Server 2005 instalado em seu computador, em seguida, você provavelmente já terá instalado no computador do SQL Server Management Studio.</span><span class="sxs-lookup"><span data-stu-id="8976d-160">If you have one of the full versions of SQL Server 2005 installed on your machine, then you likely already have SQL Server Management Studio installed on your computer.</span></span> <span data-ttu-id="8976d-161">Se você tiver apenas a edição Express, você pode baixar gratuitamente [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span><span class="sxs-lookup"><span data-stu-id="8976d-161">If you only have the Express edition, you can download the free [Microsoft SQL Server Management Studio Express Edition](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="8976d-162">Comece fechando o Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="8976d-162">Start by closing Visual Studio.</span></span> <span data-ttu-id="8976d-163">Em seguida, abra o SQL Server Management Studio e optar por conectar-se para o `localhost\SQLExpress` server usando a autenticação do Windows.</span><span class="sxs-lookup"><span data-stu-id="8976d-163">Next, open SQL Server Management Studio and choose to connect to the `localhost\SQLExpress` server using Windows Authentication.</span></span>


![Anexar o servidor localhost\SQLExpress](using-sql-cache-dependencies-cs/_static/image1.gif)

<span data-ttu-id="8976d-165">**Figura 1**: anexar o `localhost\SQLExpress` Server</span><span class="sxs-lookup"><span data-stu-id="8976d-165">**Figure 1**: Attach to the `localhost\SQLExpress` Server</span></span>


<span data-ttu-id="8976d-166">Depois de se conectar ao servidor, o Management Studio mostrará o servidor e ter subpastas para os bancos de dados, segurança e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="8976d-166">After connecting to the server, Management Studio will show the server and have subfolders for the databases, security, and so forth.</span></span> <span data-ttu-id="8976d-167">Clique com botão direito na pasta de bancos de dados e escolha a opção de anexar.</span><span class="sxs-lookup"><span data-stu-id="8976d-167">Right-click on the Databases folder and choose the Attach option.</span></span> <span data-ttu-id="8976d-168">Isso abrirá a caixa de diálogo anexar bancos de dados caixa (veja a Figura 2).</span><span class="sxs-lookup"><span data-stu-id="8976d-168">This will bring up the Attach Databases dialog box (see Figure 2).</span></span> <span data-ttu-id="8976d-169">Clique no botão Adicionar e selecione o `NORTHWND.MDF` pasta de banco de dados em seu s do aplicativo web `App_Data` pasta.</span><span class="sxs-lookup"><span data-stu-id="8976d-169">Click the Add button and select the `NORTHWND.MDF` database folder in your web application s `App_Data` folder.</span></span>


<span data-ttu-id="8976d-170">[![Anexe o northwnd não. Banco de dados MDF da pasta App_Data](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-170">[![Attach the NORTHWND.MDF Database from the App_Data Folder](using-sql-cache-dependencies-cs/_static/image2.gif)](using-sql-cache-dependencies-cs/_static/image1.png)</span></span>

<span data-ttu-id="8976d-171">**Figura 2**: anexar a `NORTHWND.MDF` do banco de dados de `App_Data` pasta ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-171">**Figure 2**: Attach the `NORTHWND.MDF` Database from the `App_Data` Folder ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image2.png))</span></span>


<span data-ttu-id="8976d-172">Isso adicionará o banco de dados para a pasta de bancos de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-172">This will add the database to the Databases folder.</span></span> <span data-ttu-id="8976d-173">O nome do banco de dados pode ser o caminho completo para o arquivo de banco de dados ou o caminho completo é anexado com um [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier).</span><span class="sxs-lookup"><span data-stu-id="8976d-173">The database name might be the full path to the database file or the full path prepended with a [GUID](http://en.wikipedia.org/wiki/Globally_Unique_Identifier).</span></span> <span data-ttu-id="8976d-174">Para evitar a necessidade de digitar esse nome de banco de dados longos ao usar o aspnet\_regsql.exe ferramenta de linha de comando, renomear o banco de dados para um nome mais amigável a humanos clicando com o banco de dados de apenas anexado e escolhendo renomear.</span><span class="sxs-lookup"><span data-stu-id="8976d-174">To avoid having to type in this lengthy database name when using the aspnet\_regsql.exe command line tool, rename the database to a more human-friendly name by right-clicking on database just attached and choosing Rename.</span></span> <span data-ttu-id="8976d-175">Eu ve renomeado meu banco de dados para DataTutorials.</span><span class="sxs-lookup"><span data-stu-id="8976d-175">I ve renamed my database to DataTutorials .</span></span>


![Renomear o banco de dados anexado a um nome mais amigável a humanos](using-sql-cache-dependencies-cs/_static/image3.gif)

<span data-ttu-id="8976d-177">**Figura 3**: renomear o banco de dados anexado a um nome mais amigável a humanos</span><span class="sxs-lookup"><span data-stu-id="8976d-177">**Figure 3**: Rename the Attached Database to a More Human-Friendly Name</span></span>


## <a name="step-3-adding-the-polling-infrastructure-to-the-northwind-database"></a><span data-ttu-id="8976d-178">Etapa 3: Adicionando a infraestrutura de sondagem para o banco de dados Northwind</span><span class="sxs-lookup"><span data-stu-id="8976d-178">Step 3: Adding the Polling Infrastructure to the Northwind Database</span></span>

<span data-ttu-id="8976d-179">Agora que podemos ter anexado a `NORTHWND.MDF` do banco de dados a `App_Data` pasta, podemos está pronto para adicionar a infraestrutura de sondagem.</span><span class="sxs-lookup"><span data-stu-id="8976d-179">Now that we have attached the `NORTHWND.MDF` database from the `App_Data` folder, we re ready to add the polling infrastructure.</span></span> <span data-ttu-id="8976d-180">Supondo que você tiver renomeado o banco de dados para DataTutorials, execute os seguintes quatro comandos:</span><span class="sxs-lookup"><span data-stu-id="8976d-180">Assuming that you ve renamed the database to DataTutorials, run the following four commands:</span></span>


[!code-console[Main](using-sql-cache-dependencies-cs/samples/sample5.cmd)]

<span data-ttu-id="8976d-181">Depois de executar essas quatro comandos, clique com botão direito no nome do banco de dados no Management Studio, vá para o submenu de tarefas e escolha desanexar.</span><span class="sxs-lookup"><span data-stu-id="8976d-181">After running these four commands, right-click on the database name in Management Studio, go to the Tasks submenu, and choose Detach.</span></span> <span data-ttu-id="8976d-182">Em seguida, feche o Management Studio e reabra o Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="8976d-182">Then close Management Studio and reopen Visual Studio.</span></span>

<span data-ttu-id="8976d-183">Depois que o Visual Studio tem reaberto, analise o banco de dados por meio do Gerenciador de servidores.</span><span class="sxs-lookup"><span data-stu-id="8976d-183">Once Visual Studio has reopened, drill into the database through the Server Explorer.</span></span> <span data-ttu-id="8976d-184">Observe a nova tabela (`AspNet_SqlCacheTablesForChangeNotification`), o novo procedimentos armazenados e gatilhos em de `Products`, `Categories`, e `Suppliers` tabelas.</span><span class="sxs-lookup"><span data-stu-id="8976d-184">Note the new table (`AspNet_SqlCacheTablesForChangeNotification`), the new stored procedures, and the triggers on the `Products`, `Categories`, and `Suppliers` tables.</span></span>


![O banco de dados agora inclui a infraestrutura necessária sondagem](using-sql-cache-dependencies-cs/_static/image4.gif)

<span data-ttu-id="8976d-186">**Figura 4**: O banco de dados agora inclui a infraestrutura necessária sondagem</span><span class="sxs-lookup"><span data-stu-id="8976d-186">**Figure 4**: The Database Now Includes the Necessary Polling Infrastructure</span></span>


## <a name="step-4-configuring-the-polling-service"></a><span data-ttu-id="8976d-187">Etapa 4: Configurar o serviço de sondagem</span><span class="sxs-lookup"><span data-stu-id="8976d-187">Step 4: Configuring the Polling Service</span></span>

<span data-ttu-id="8976d-188">Depois de criar as tabelas necessárias, gatilhos e procedimentos armazenados no banco de dados, a etapa final é configurar o serviço de sondagem, o que é feito por meio de `Web.config` especificando os bancos de dados para uso e a frequência de sondagem, em milissegundos.</span><span class="sxs-lookup"><span data-stu-id="8976d-188">After creating the needed tables, triggers, and stored procedures in the database, the final step is to configure the polling service, which is done through `Web.config` by specifying the databases to use and the polling frequency in milliseconds.</span></span> <span data-ttu-id="8976d-189">A marcação a seguir sonda uma vez por segundo de banco de dados Northwind.</span><span class="sxs-lookup"><span data-stu-id="8976d-189">The following markup polls the Northwind database once every second.</span></span>


[!code-xml[Main](using-sql-cache-dependencies-cs/samples/sample6.xml)]

<span data-ttu-id="8976d-190">O `name` o valor de `<add>` (NorthwindDB) do elemento associa um nome legível por humanos com um determinado banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-190">The `name` value in the `<add>` element ( NorthwindDB ) associates a human-readable name with a particular database.</span></span> <span data-ttu-id="8976d-191">Ao trabalhar com dependências de cache SQL, precisaremos fazer referência ao nome do banco de dados definido aqui, bem como os dados em cache com base na tabela.</span><span class="sxs-lookup"><span data-stu-id="8976d-191">When working with SQL cache dependencies, we'll need to refer to the database name defined here as well as the table that the cached data is based on.</span></span> <span data-ttu-id="8976d-192">Veremos como usar o `SqlCacheDependency` classe para associar programaticamente as dependências de cache SQL com armazenados em cache dados na etapa 6.</span><span class="sxs-lookup"><span data-stu-id="8976d-192">We'll see how to use the `SqlCacheDependency` class to programmatically associate SQL cache dependencies with cached data in Step 6.</span></span>

<span data-ttu-id="8976d-193">Quando uma dependência de cache SQL tiver sido estabelecida, o sistema de sondagem se conectará aos bancos de dados definidos na `<databases>` elementos cada `pollTime` milissegundos e executar o `AspNet_SqlCachePollingStoredProcedure` procedimento armazenado.</span><span class="sxs-lookup"><span data-stu-id="8976d-193">Once a SQL cache dependency has been established, the polling system will connect to the databases defined in the `<databases>` elements every `pollTime` milliseconds and execute the `AspNet_SqlCachePollingStoredProcedure` stored procedure.</span></span> <span data-ttu-id="8976d-194">Esse procedimento armazenado - que foi adicionado de volta na etapa 3 usando o `aspnet_regsql.exe` ferramenta de linha de comando - retorna o `tableName` e `changeId` valores para cada registro em `AspNet_SqlCacheTablesForChangeNotification`.</span><span class="sxs-lookup"><span data-stu-id="8976d-194">This stored procedure - which was added back in Step 3 using the `aspnet_regsql.exe` command line tool - returns the `tableName` and `changeId` values for each record in `AspNet_SqlCacheTablesForChangeNotification`.</span></span> <span data-ttu-id="8976d-195">Dependências de cache SQL desatualizadas serão removidas do cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-195">Outdated SQL cache dependencies are evicted from the cache.</span></span>

<span data-ttu-id="8976d-196">O `pollTime` configuração apresenta um equilíbrio entre desempenho e desatualização limitada de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-196">The `pollTime` setting introduces a tradeoff between performance and data staleness.</span></span> <span data-ttu-id="8976d-197">Um pequeno `pollTime` valor aumenta o número de solicitações para o banco de dados, mas muito mais rapidamente remove dados obsoletos do cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-197">A small `pollTime` value increases the number of requests to the database, but more quickly evicts stale data from the cache.</span></span> <span data-ttu-id="8976d-198">Uma maior `pollTime` valor reduz o número de solicitações de banco de dados, mas aumenta o atraso entre quando os dados de back-end são alterados e quando os itens de cache relacionadas são removidos.</span><span class="sxs-lookup"><span data-stu-id="8976d-198">A larger `pollTime` value reduces the number of database requests, but increases the delay between when the backend data changes and when the related cache items are evicted.</span></span> <span data-ttu-id="8976d-199">Felizmente, a solicitação de banco de dados está executando um procedimento armazenado simples que s retornando apenas algumas linhas de uma tabela simple e leve.</span><span class="sxs-lookup"><span data-stu-id="8976d-199">Fortunately, the database request is executing a simple stored procedure that s returning just a few rows from a simple, lightweight table.</span></span> <span data-ttu-id="8976d-200">Mas fazer experiências com diferentes `pollTime` valores para encontrar um equilíbrio ideal entre desatualização limitada de dados e acesso para seu aplicativo de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-200">But do experiment with different `pollTime` values to find an ideal balance between database access and data staleness for your application.</span></span> <span data-ttu-id="8976d-201">O menor `pollTime` valor permitido é de 500.</span><span class="sxs-lookup"><span data-stu-id="8976d-201">The smallest `pollTime` value allowed is 500.</span></span>

> [!NOTE]
> <span data-ttu-id="8976d-202">O exemplo acima fornece uma única `pollTime` valor em de `<sqlCacheDependency>` elemento, mas você pode opcionalmente especificar o `pollTime` valor no `<add>` elemento.</span><span class="sxs-lookup"><span data-stu-id="8976d-202">The above example provides a single `pollTime` value in the `<sqlCacheDependency>` element, but you can optionally specify the `pollTime` value in the `<add>` element.</span></span> <span data-ttu-id="8976d-203">Isso é útil se você tiver vários bancos de dados especificados e para personalizar a frequência de sondagem por banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-203">This is useful if you have multiple databases specified and want to customize the polling frequency per database.</span></span>


## <a name="step-5-declaratively-working-with-sql-cache-dependencies"></a><span data-ttu-id="8976d-204">Etapa 5: Declarativamente trabalhando com dependências de Cache SQL</span><span class="sxs-lookup"><span data-stu-id="8976d-204">Step 5: Declaratively Working with SQL Cache Dependencies</span></span>

<span data-ttu-id="8976d-205">As etapas 1 a 4 examinamos como configurar a infraestrutura de banco de dados necessários e configurar o sistema de pesquisa.</span><span class="sxs-lookup"><span data-stu-id="8976d-205">In Steps 1 through 4 we looked at how to setup the necessary database infrastructure and configure the polling system.</span></span> <span data-ttu-id="8976d-206">Com essa infra-estrutura in-loco, podemos agora pode adicionar itens ao cache de dados com uma dependência de cache SQL associada usando técnicas de programação ou declarativas.</span><span class="sxs-lookup"><span data-stu-id="8976d-206">With this infrastructure in place, we can now add items to the data cache with an associated SQL cache dependency using either programmatic or declarative techniques.</span></span> <span data-ttu-id="8976d-207">Nesta etapa, examinaremos como declarativamente trabalhar com dependências de cache SQL.</span><span class="sxs-lookup"><span data-stu-id="8976d-207">In this step we'll examine how to declaratively work with SQL cache dependencies.</span></span> <span data-ttu-id="8976d-208">Etapa 6, examinaremos a abordagem programática.</span><span class="sxs-lookup"><span data-stu-id="8976d-208">In Step 6 we'll look at the programmatic approach.</span></span>

<span data-ttu-id="8976d-209">O [armazenando dados com o ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial explorou as capacidades declarativas de cache do ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="8976d-209">The [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial explored the declarative caching capabilities of the ObjectDataSource.</span></span> <span data-ttu-id="8976d-210">Simplesmente definindo a `EnableCaching` propriedade para `true` e o `CacheDuration` propriedade algum intervalo de tempo, o ObjectDataSource armazenará em cache automaticamente os dados retornados de seu objeto subjacente para o intervalo especificado.</span><span class="sxs-lookup"><span data-stu-id="8976d-210">By simply setting the `EnableCaching` property to `true` and the `CacheDuration` property to some time interval, the ObjectDataSource will automatically cache the data returned from its underlying object for the specified interval.</span></span> <span data-ttu-id="8976d-211">O ObjectDataSource também pode usar uma ou mais dependências de cache SQL.</span><span class="sxs-lookup"><span data-stu-id="8976d-211">The ObjectDataSource can also use one or more SQL cache dependencies.</span></span>

<span data-ttu-id="8976d-212">Para demonstrar o uso de dependências de cache SQL declarativamente, abra o `SqlCacheDependencies.aspx` página o `Caching` pasta e arraste um controle GridView na caixa de ferramentas para o Designer.</span><span class="sxs-lookup"><span data-stu-id="8976d-212">To demonstrate using SQL cache dependencies declaratively, open the `SqlCacheDependencies.aspx` page in the `Caching` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="8976d-213">Definir o s GridView `ID` à `ProductsDeclarative` e, na marca inteligente, de escolha para associá-lo para um novo ObjectDataSource chamado `ProductsDataSourceDeclarative`.</span><span class="sxs-lookup"><span data-stu-id="8976d-213">Set the GridView s `ID` to `ProductsDeclarative` and, from its smart tag, choose to bind it to a new ObjectDataSource named `ProductsDataSourceDeclarative`.</span></span>


<span data-ttu-id="8976d-214">[![Criar um novo ObjectDataSource chamado ProductsDataSourceDeclarative](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-214">[![Create a New ObjectDataSource Named ProductsDataSourceDeclarative](using-sql-cache-dependencies-cs/_static/image5.gif)](using-sql-cache-dependencies-cs/_static/image3.png)</span></span>

<span data-ttu-id="8976d-215">**Figura 5**: criar um novo ObjectDataSource nomeado `ProductsDataSourceDeclarative` ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-215">**Figure 5**: Create a New ObjectDataSource Named `ProductsDataSourceDeclarative` ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image4.png))</span></span>


<span data-ttu-id="8976d-216">Configurar o ObjectDataSource para usar o `ProductsBLL` de classe e defina a lista suspensa na guia SELECT para `GetProducts()`.</span><span class="sxs-lookup"><span data-stu-id="8976d-216">Configure the ObjectDataSource to use the `ProductsBLL` class and set the drop-down list in the SELECT tab to `GetProducts()`.</span></span> <span data-ttu-id="8976d-217">Na guia de atualização, escolha o `UpdateProduct` sobrecarga com três parâmetros de entrada - `productName`, `unitPrice`, e `productID`.</span><span class="sxs-lookup"><span data-stu-id="8976d-217">In the UPDATE tab, choose the `UpdateProduct` overload with three input parameters - `productName`, `unitPrice`, and `productID`.</span></span> <span data-ttu-id="8976d-218">Defina as listas suspensas para (nenhum) nas guias INSERT e DELETE.</span><span class="sxs-lookup"><span data-stu-id="8976d-218">Set the drop-down lists to (None) in the INSERT and DELETE tabs.</span></span>


<span data-ttu-id="8976d-219">[![Use a sobrecarga de UpdateProduct com três parâmetros de entrada](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-219">[![Use the UpdateProduct Overload with Three Input Parameters](using-sql-cache-dependencies-cs/_static/image6.gif)](using-sql-cache-dependencies-cs/_static/image5.png)</span></span>

<span data-ttu-id="8976d-220">**Figura 6**: Use a sobrecarga de UpdateProduct com três parâmetros de entrada ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-220">**Figure 6**: Use the UpdateProduct Overload with Three Input Parameters ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image6.png))</span></span>


<span data-ttu-id="8976d-221">[![Definir a lista suspensa como (nenhum) para a inserção e exclusão guias](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-221">[![Set the Drop-Down List to (None) for the INSERT and DELETE Tabs](using-sql-cache-dependencies-cs/_static/image7.gif)](using-sql-cache-dependencies-cs/_static/image7.png)</span></span>

<span data-ttu-id="8976d-222">**Figura 7**: defina a lista suspensa como (nenhum) para a inserção e excluir guias ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-222">**Figure 7**: Set the Drop-Down List to (None) for the INSERT and DELETE Tabs ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image8.png))</span></span>


<span data-ttu-id="8976d-223">Depois de concluir o Assistente Configurar fonte de dados, o Visual Studio criará BoundFields e CheckBoxFields no GridView para cada um dos campos de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-223">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="8976d-224">Remover todos os campos, mas `ProductName`, `CategoryName`, e `UnitPrice`e formatar esses campos conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="8976d-224">Remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="8976d-225">Da GridView s marca inteligente, marque as caixas de seleção Habilitar paginação, habilitar a classificação e habilitar edição.</span><span class="sxs-lookup"><span data-stu-id="8976d-225">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="8976d-226">Visual Studio definirá o s ObjectDataSource `OldValuesParameterFormatString` propriedade para `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="8976d-226">Visual Studio will set the ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="8976d-227">Em ordem para o recurso de edição de s GridView funcione corretamente, remova essa propriedade inteiramente da sintaxe declarativa ou conjunto de volta ao seu valor padrão, `{0}`.</span><span class="sxs-lookup"><span data-stu-id="8976d-227">In order for the GridView s edit feature to work properly, either remove this property entirely from the declarative syntax or set it back to its default value, `{0}`.</span></span>

<span data-ttu-id="8976d-228">Por fim, adicione um controle de rótulo Web acima a GridView e defina sua `ID` propriedade para `ODSEvents` e seu `EnableViewState` propriedade `false`.</span><span class="sxs-lookup"><span data-stu-id="8976d-228">Finally, add a Label Web control above the GridView and set its `ID` property to `ODSEvents` and its `EnableViewState` property to `false`.</span></span> <span data-ttu-id="8976d-229">Depois de fazer essas alterações, sua marcação declarativa de s de página deve ser semelhante ao seguinte.</span><span class="sxs-lookup"><span data-stu-id="8976d-229">After making these changes, your page s declarative markup should look similar to the following.</span></span> <span data-ttu-id="8976d-230">Observe que eu chegou uma série de personalizações estéticas para os campos de GridView que não são necessários para demonstrar a funcionalidade de dependência de cache SQL.</span><span class="sxs-lookup"><span data-stu-id="8976d-230">Note that I ve made a number of aesthetic customizations to the GridView fields that are not necessary to demonstrate the SQL cache dependency functionality.</span></span>


[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample7.aspx)]

<span data-ttu-id="8976d-231">Em seguida, crie um manipulador de eventos para o s ObjectDataSource `Selecting` eventos e em, adicione o código a seguir:</span><span class="sxs-lookup"><span data-stu-id="8976d-231">Next, create an event handler for the ObjectDataSource s `Selecting` event and in it add the following code:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample8.cs)]

<span data-ttu-id="8976d-232">Lembre-se de que o s ObjectDataSource `Selecting` evento é acionado somente quando a recuperação de dados de seu objeto subjacente.</span><span class="sxs-lookup"><span data-stu-id="8976d-232">Recall that the ObjectDataSource s `Selecting` event fires only when retrieving data from its underlying object.</span></span> <span data-ttu-id="8976d-233">Se o ObjectDataSource acessa os dados de seu próprio cache, esse evento não é acionado.</span><span class="sxs-lookup"><span data-stu-id="8976d-233">If the ObjectDataSource accesses the data from its own cache, this event is not fired.</span></span>

<span data-ttu-id="8976d-234">Agora, visite esta página por meio de um navegador.</span><span class="sxs-lookup"><span data-stu-id="8976d-234">Now, visit this page through a browser.</span></span> <span data-ttu-id="8976d-235">Desde que criamos ve ainda devem implementar qualquer cache, sempre que a página, classificar ou editar a grade de página deve exibir o texto, o evento Selecting acionado, como mostra a Figura 8.</span><span class="sxs-lookup"><span data-stu-id="8976d-235">Since we ve yet to implement any caching, each time you page, sort, or edit the grid the page should display the text, �Selecting event fired, as Figure 8 shows.</span></span>


<span data-ttu-id="8976d-236">[![O s ObjectDataSource selecionando evento é acionado cada vez GridView é paginado, editados, ou Sorted](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-236">[![The ObjectDataSource s Selecting Event Fires Each Time the GridView is Paged, Edited, or Sorted](using-sql-cache-dependencies-cs/_static/image8.gif)](using-sql-cache-dependencies-cs/_static/image9.png)</span></span>

<span data-ttu-id="8976d-237">**Figura 8**: s o ObjectDataSource `Selecting` evento é acionado cada vez, GridView é paginado, editada ou Sorted ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-237">**Figure 8**: The ObjectDataSource s `Selecting` Event Fires Each Time the GridView is Paged, Edited, or Sorted ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image10.png))</span></span>


<span data-ttu-id="8976d-238">Como vimos na [armazenando dados com o ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial, definindo o `EnableCaching` propriedade a ser `true` faz com que o ObjectDataSource para armazenar em cache seus dados para a duração especificada por seu `CacheDuration` propriedade.</span><span class="sxs-lookup"><span data-stu-id="8976d-238">As we saw in the [Caching Data with the ObjectDataSource](caching-data-with-the-objectdatasource-cs.md) tutorial, setting the `EnableCaching` property to `true` causes the ObjectDataSource to cache its data for the duration specified by its `CacheDuration` property.</span></span> <span data-ttu-id="8976d-239">O ObjectDataSource também tem um [ `SqlCacheDependency` propriedade](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), que adiciona uma ou mais dependências de cache SQL para os dados em cache usando o padrão:</span><span class="sxs-lookup"><span data-stu-id="8976d-239">The ObjectDataSource also has a [`SqlCacheDependency` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sqlcachedependency.aspx), which adds one or more SQL cache dependencies to the cached data using the pattern:</span></span>


[!code-css[Main](using-sql-cache-dependencies-cs/samples/sample9.css)]

<span data-ttu-id="8976d-240">Onde *databaseName* é o nome do banco de dados conforme especificado na `name` atributo do `<add>` elemento `Web.config`, e *tableName* é o nome da tabela de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-240">Where *databaseName* is the name of the database as specified in the `name` attribute of the `<add>` element in `Web.config`, and *tableName* is the name of the database table.</span></span> <span data-ttu-id="8976d-241">Por exemplo criar um ObjectDataSource que armazena em cache os dados indefinidamente, com base em uma dependência de cache SQL em relação a s Northwind `Products` da tabela, definir o s ObjectDataSource `EnableCaching` propriedade a ser `true` e sua `SqlCacheDependency` propriedade para NorthwindDB:Products.</span><span class="sxs-lookup"><span data-stu-id="8976d-241">For example, to create an ObjectDataSource that caches data indefinitely based on a SQL cache dependency against the Northwind s `Products` table, set the ObjectDataSource s `EnableCaching` property to `true` and its `SqlCacheDependency` property to NorthwindDB:Products .</span></span>

> [!NOTE]
> <span data-ttu-id="8976d-242">Você pode usar uma dependência de cache SQL *e* uma expiração com base no tempo, definindo `EnableCaching` à `true`, `CacheDuration` para o intervalo de tempo e `SqlCacheDependency` para o nome de banco de dados e tabela (s).</span><span class="sxs-lookup"><span data-stu-id="8976d-242">You can use a SQL cache dependency *and* a time-based expiry by setting `EnableCaching` to `true`, `CacheDuration` to the time interval, and `SqlCacheDependency` to the database and table name(s).</span></span> <span data-ttu-id="8976d-243">O ObjectDataSource removerá seus dados quando a expiração do tempo for atingida ou quando o sistema de sondagem observa que o banco de dados subjacente foi alterado, o que ocorrer primeiro.</span><span class="sxs-lookup"><span data-stu-id="8976d-243">The ObjectDataSource will evict its data when the time-based expiry is reached or when the polling system notes that the underlying database data has changed, whichever happens first.</span></span>


<span data-ttu-id="8976d-244">O GridView no `SqlCacheDependencies.aspx` exibe dados de duas tabelas - `Products` e `Categories` (o produto s `CategoryName` campo é recuperado por meio de um `JOIN` em `Categories`).</span><span class="sxs-lookup"><span data-stu-id="8976d-244">The GridView in `SqlCacheDependencies.aspx` displays data from two tables - `Products` and `Categories` (the product s `CategoryName` field is retrieved via a `JOIN` on `Categories`).</span></span> <span data-ttu-id="8976d-245">Portanto, queremos especificar duas dependências de cache SQL: NorthwindDB:Products; NorthwindDB:Categories.</span><span class="sxs-lookup"><span data-stu-id="8976d-245">Therefore, we want to specify two SQL cache dependencies: NorthwindDB:Products;NorthwindDB:Categories .</span></span>


<span data-ttu-id="8976d-246">[![Configurar o ObjectDataSource para dar suporte a cache usando as dependências de Cache SQL em categorias e produtos](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-246">[![Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on Products and Categories](using-sql-cache-dependencies-cs/_static/image9.gif)](using-sql-cache-dependencies-cs/_static/image11.png)</span></span>

<span data-ttu-id="8976d-247">**Figura 9**: Configure o ObjectDataSource para suporte ao cache usando o SQL dependências de Cache no `Products` e `Categories` ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-247">**Figure 9**: Configure the ObjectDataSource to Support Caching Using SQL Cache Dependencies on `Products` and `Categories` ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image12.png))</span></span>


<span data-ttu-id="8976d-248">Depois de configurar o ObjectDataSource para dar suporte a armazenamento em cache, revisita a página por meio de um navegador.</span><span class="sxs-lookup"><span data-stu-id="8976d-248">After configuring the ObjectDataSource to support caching, revisit the page through a browser.</span></span> <span data-ttu-id="8976d-249">Novamente, o evento de seleção de texto acionado deve aparecer na primeira visita de página, mas deve desaparecer durante a paginação, classificação ou clicando nos botões de edição ou em Cancelar.</span><span class="sxs-lookup"><span data-stu-id="8976d-249">Again, the text �Selecting event fired should appear on the first page visit, but should go away when paging, sorting, or clicking the Edit or Cancel buttons.</span></span> <span data-ttu-id="8976d-250">Isso ocorre porque depois que os dados são carregados no cache de s ObjectDataSource, ela permanece lá até que o `Products` ou `Categories` tabelas são modificadas ou os dados são atualizados por meio de GridView.</span><span class="sxs-lookup"><span data-stu-id="8976d-250">This is because after the data is loaded into the ObjectDataSource s cache, it remains there until the `Products` or `Categories` tables are modified or the data is updated through the GridView.</span></span>

<span data-ttu-id="8976d-251">Depois de paginação por meio da grade e observar a falta do evento Selecting acionado texto, abra uma nova janela do navegador e navegue até o tutorial de conceitos básicos de edição, inserção e exclusão de seção (`~/EditInsertDelete/Basics.aspx`).</span><span class="sxs-lookup"><span data-stu-id="8976d-251">After paging through the grid and noting the lack of the �Selecting event fired text, open a new browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="8976d-252">Atualize o nome ou o preço de um produto.</span><span class="sxs-lookup"><span data-stu-id="8976d-252">Update the name or price of a product.</span></span> <span data-ttu-id="8976d-253">Em seguida, de, para a primeira janela do navegador, exibir uma página de dados diferente, classificar a grade ou clique em um botão de edição de linha s.</span><span class="sxs-lookup"><span data-stu-id="8976d-253">Then, from to the first browser window, view a different page of data, sort the grid, or click a row s Edit button.</span></span> <span data-ttu-id="8976d-254">Neste momento, o evento Selecting acionado deverá reaparecer, como o banco de dados subjacente que dados foram modificadas (veja a Figura 10).</span><span class="sxs-lookup"><span data-stu-id="8976d-254">This time, the �Selecting event fired should reappear, as the underlying database data has been modified (see Figure 10).</span></span> <span data-ttu-id="8976d-255">Se o texto não aparecer, aguarde alguns instantes e tente novamente.</span><span class="sxs-lookup"><span data-stu-id="8976d-255">If the text does not appear, wait a few moments and try again.</span></span> <span data-ttu-id="8976d-256">Lembre-se de que o serviço de sondagem está verificando se há alterações para o `Products` tabela cada `pollTime` milissegundos, portanto, não há um atraso entre quando os dados subjacentes são atualizados e quando os dados em cache seja removidos.</span><span class="sxs-lookup"><span data-stu-id="8976d-256">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>


<span data-ttu-id="8976d-257">[![Modificando a tabela de produtos remove os dados do produto armazenada em cache](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-257">[![Modifying the Products Table Evicts the Cached Product Data](using-sql-cache-dependencies-cs/_static/image10.gif)](using-sql-cache-dependencies-cs/_static/image13.png)</span></span>

<span data-ttu-id="8976d-258">**Figura 10**: modificando a tabela de produtos remove os dados do produto armazenada em cache ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-258">**Figure 10**: Modifying the Products Table Evicts the Cached Product Data ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image14.png))</span></span>


## <a name="step-6-programmatically-working-with-thesqlcachedependencyclass"></a><span data-ttu-id="8976d-259">Etapa 6: Trabalhando programaticamente com o`SqlCacheDependency`classe</span><span class="sxs-lookup"><span data-stu-id="8976d-259">Step 6: Programmatically Working with the`SqlCacheDependency`Class</span></span>

<span data-ttu-id="8976d-260">O [dados em cache na arquitetura](caching-data-in-the-architecture-cs.md) tutorial examinou os benefícios de usar uma camada separada do serviço de cache na arquitetura em vez de acoplando com segurança o armazenamento em cache com o ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="8976d-260">The [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorial looked at the benefits of using a separate Caching Layer in the architecture as opposed to tightly coupling the caching with the ObjectDataSource.</span></span> <span data-ttu-id="8976d-261">No tutorial, criamos um `ProductsCL` para demonstrar a trabalhar programaticamente com o cache de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-261">In that tutorial we created a `ProductsCL` class to demonstrate programmatically working with the data cache.</span></span> <span data-ttu-id="8976d-262">Para utilizar as dependências de cache SQL na camada de armazenamento em cache, use o `SqlCacheDependency` classe.</span><span class="sxs-lookup"><span data-stu-id="8976d-262">To utilize SQL cache dependencies in the Caching Layer, use the `SqlCacheDependency` class.</span></span>

<span data-ttu-id="8976d-263">Com o sistema de sondagem, um `SqlCacheDependency` objeto deve ser associado um determinado par de banco de dados e tabela.</span><span class="sxs-lookup"><span data-stu-id="8976d-263">With the polling system, a `SqlCacheDependency` object must be associated with a particular database and table pair.</span></span> <span data-ttu-id="8976d-264">O código a seguir, por exemplo, cria uma `SqlCacheDependency` objeto com base no banco de dados Northwind s `Products` tabela:</span><span class="sxs-lookup"><span data-stu-id="8976d-264">The following code, for example, creates a `SqlCacheDependency` object based on the Northwind database s `Products` table:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample10.cs)]

<span data-ttu-id="8976d-265">Os dois parâmetros de entrada para o `SqlCacheDependency` construtor s são os nomes de banco de dados e tabela, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="8976d-265">The two input parameters to the `SqlCacheDependency` s constructor are the database and table names, respectively.</span></span> <span data-ttu-id="8976d-266">Como com o ObjectDataSource s `SqlCacheDependency` propriedade, o nome de banco de dados usado é o mesmo que o valor especificado em de `name` atributo do `<add>` elemento no `Web.config`.</span><span class="sxs-lookup"><span data-stu-id="8976d-266">Like with the ObjectDataSource s `SqlCacheDependency` property, the database name used is the same as the value specified in the `name` attribute of the `<add>` element in `Web.config`.</span></span> <span data-ttu-id="8976d-267">O nome da tabela é o nome real da tabela de banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-267">The table name is the actual name of the database table.</span></span>

<span data-ttu-id="8976d-268">Para associar uma `SqlCacheDependency` com um item adicionado ao cache de dados, use um do `Insert` sobrecargas de método que aceita uma dependência.</span><span class="sxs-lookup"><span data-stu-id="8976d-268">To associate a `SqlCacheDependency` with an item added to the data cache, use one of the `Insert` method overloads that accepts a dependency.</span></span> <span data-ttu-id="8976d-269">O código a seguir adiciona *valor* para o cache de dados para uma duração indefinido, mas associa a um `SqlCacheDependency` no `Products` tabela.</span><span class="sxs-lookup"><span data-stu-id="8976d-269">The following code adds *value* to the data cache for an indefinite duration, but associates it with a `SqlCacheDependency` on the `Products` table.</span></span> <span data-ttu-id="8976d-270">Em resumo, *valor* permanecerão no cache até que ele é removido devido a restrições de memória ou porque o sistema de sondagem detectou que o `Products` tabela foi alterado desde que foi armazenado em cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-270">In short, *value* will remain in the cache until it is evicted due to memory constraints or because the polling system has detected that the `Products` table has changed since it was cached.</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample11.cs)]

<span data-ttu-id="8976d-271">A camada de armazenamento em cache s `ProductsCL` classe atualmente armazena em cache dados do `Products` tabela usando uma expiração com base no tempo de 60 segundos.</span><span class="sxs-lookup"><span data-stu-id="8976d-271">The Caching Layer s `ProductsCL` class currently caches data from the `Products` table using a time-based expiry of 60 seconds.</span></span> <span data-ttu-id="8976d-272">Deixe o s atualizar essa classe para que ele usa as dependências de cache SQL em vez disso.</span><span class="sxs-lookup"><span data-stu-id="8976d-272">Let s update this class so that it uses SQL cache dependencies instead.</span></span> <span data-ttu-id="8976d-273">O `ProductsCL` classe s `AddCacheItem` método, que é responsável por adicionar os dados no cache, no momento, contém o código a seguir:</span><span class="sxs-lookup"><span data-stu-id="8976d-273">The `ProductsCL` class s `AddCacheItem` method, which is responsible for adding the data to the cache, currently contains the following code:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample12.cs)]

<span data-ttu-id="8976d-274">Atualizar este código para usar um `SqlCacheDependency` do objeto, em vez do `MasterCacheKeyArray` a dependência de cache:</span><span class="sxs-lookup"><span data-stu-id="8976d-274">Update this code to use a `SqlCacheDependency` object instead of the `MasterCacheKeyArray` cache dependency:</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample13.cs)]

<span data-ttu-id="8976d-275">Para testar essa funcionalidade, adicione um controle GridView à página abaixo existente `ProductsDeclarative` GridView.</span><span class="sxs-lookup"><span data-stu-id="8976d-275">To test this functionality, add a GridView to the page beneath the existing `ProductsDeclarative` GridView.</span></span> <span data-ttu-id="8976d-276">Definir esse novo s GridView `ID` à `ProductsProgrammatic` e, por meio de sua marca inteligente, associá-lo a um novo ObjectDataSource chamado `ProductsDataSourceProgrammatic`.</span><span class="sxs-lookup"><span data-stu-id="8976d-276">Set this new GridView s `ID` to `ProductsProgrammatic` and, through its smart tag, bind it to a new ObjectDataSource named `ProductsDataSourceProgrammatic`.</span></span> <span data-ttu-id="8976d-277">Configurar o ObjectDataSource para usar o `ProductsCL` classe, definindo as listas suspensas em SELECT e guias de atualização para `GetProducts` e `UpdateProduct`, respectivamente.</span><span class="sxs-lookup"><span data-stu-id="8976d-277">Configure the ObjectDataSource to use the `ProductsCL` class, setting the drop-down lists in the SELECT and UPDATE tabs to `GetProducts` and `UpdateProduct`, respectively.</span></span>


<span data-ttu-id="8976d-278">[![Configurar o ObjectDataSource para usar a classe ProductsCL](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-278">[![Configure the ObjectDataSource to Use the ProductsCL Class](using-sql-cache-dependencies-cs/_static/image11.gif)](using-sql-cache-dependencies-cs/_static/image15.png)</span></span>

<span data-ttu-id="8976d-279">**Figura 11**: configurar o ObjectDataSource para usar o `ProductsCL` classe ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-279">**Figure 11**: Configure the ObjectDataSource to Use the `ProductsCL` Class ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image16.png))</span></span>


<span data-ttu-id="8976d-280">[![Selecione o método GetProducts na lista suspensa Selecione guia s](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-280">[![Select the GetProducts Method from the SELECT Tab s Drop-Down List](using-sql-cache-dependencies-cs/_static/image12.gif)](using-sql-cache-dependencies-cs/_static/image17.png)</span></span>

<span data-ttu-id="8976d-281">**Figura 12**: selecione o `GetProducts` método de s selecione guia lista suspensa ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-281">**Figure 12**: Select the `GetProducts` Method from the SELECT Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image18.png))</span></span>


<span data-ttu-id="8976d-282">[![Escolha o método UpdateProduct na lista de lista suspensa da guia s atualização](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="8976d-282">[![Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List](using-sql-cache-dependencies-cs/_static/image13.gif)](using-sql-cache-dependencies-cs/_static/image19.png)</span></span>

<span data-ttu-id="8976d-283">**Figura 13**: escolha o método UpdateProduct de guia de atualização s lista suspensa ([clique para exibir a imagem em tamanho normal](using-sql-cache-dependencies-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="8976d-283">**Figure 13**: Choose the UpdateProduct Method from the UPDATE Tab s Drop-Down List ([Click to view full-size image](using-sql-cache-dependencies-cs/_static/image20.png))</span></span>


<span data-ttu-id="8976d-284">Depois de concluir o Assistente Configurar fonte de dados, o Visual Studio criará BoundFields e CheckBoxFields no GridView para cada um dos campos de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-284">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and CheckBoxFields in the GridView for each of the data fields.</span></span> <span data-ttu-id="8976d-285">Como com o GridView primeiro adicionado a esta página, remova todos os campos, mas `ProductName`, `CategoryName`, e `UnitPrice`e formatar esses campos conforme necessário.</span><span class="sxs-lookup"><span data-stu-id="8976d-285">Like with the first GridView added to this page, remove all fields but `ProductName`, `CategoryName`, and `UnitPrice`, and format these fields as you see fit.</span></span> <span data-ttu-id="8976d-286">Da GridView s marca inteligente, marque as caixas de seleção Habilitar paginação, habilitar a classificação e habilitar edição.</span><span class="sxs-lookup"><span data-stu-id="8976d-286">From the GridView s smart tag, check the Enable Paging, Enable Sorting, and Enable Editing checkboxes.</span></span> <span data-ttu-id="8976d-287">Assim como acontece com o `ProductsDataSourceDeclarative` ObjectDataSource, o Visual Studio definirá a `ProductsDataSourceProgrammatic` s ObjectDataSource `OldValuesParameterFormatString` propriedade `original_{0}`.</span><span class="sxs-lookup"><span data-stu-id="8976d-287">As with the `ProductsDataSourceDeclarative` ObjectDataSource, Visual Studio will set the `ProductsDataSourceProgrammatic` ObjectDataSource s `OldValuesParameterFormatString` property to `original_{0}`.</span></span> <span data-ttu-id="8976d-288">Para que o recurso de edição de s GridView funcionar corretamente, defina essa propriedade de volta para `{0}` (ou remover a atribuição de propriedade da sintaxe declarativa completamente).</span><span class="sxs-lookup"><span data-stu-id="8976d-288">In order for the GridView s edit feature to work properly, set this property back to `{0}` (or remove the property assignment from the declarative syntax altogether).</span></span>

<span data-ttu-id="8976d-289">Depois de concluir essas tarefas, a marcação declarativa GridView e ObjectDataSource resultante deve ser semelhante ao seguinte:</span><span class="sxs-lookup"><span data-stu-id="8976d-289">After completing these tasks, the resulting GridView and ObjectDataSource declarative markup should look like the following:</span></span>


[!code-aspx[Main](using-sql-cache-dependencies-cs/samples/sample14.aspx)]

<span data-ttu-id="8976d-290">Para testar o SQL dependência de cache na camada de cache definir um ponto de interrupção na `ProductCL` classe s `AddCacheItem` método e, em seguida, para começar a depuração.</span><span class="sxs-lookup"><span data-stu-id="8976d-290">To test the SQL cache dependency in the Caching Layer set a breakpoint in the `ProductCL` class s `AddCacheItem` method and then start debugging.</span></span> <span data-ttu-id="8976d-291">Quando você visita primeiro `SqlCacheDependencies.aspx`, o ponto de interrupção deve ser atingido conforme os dados são solicitados pela primeira vez e colocados no cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-291">When you first visit `SqlCacheDependencies.aspx`, the breakpoint should be hit as the data is requested for the first time and placed into the cache.</span></span> <span data-ttu-id="8976d-292">Em seguida, mover para outra página do GridView ou uma das colunas de classificação.</span><span class="sxs-lookup"><span data-stu-id="8976d-292">Next, move to another page in the GridView or sort one of the columns.</span></span> <span data-ttu-id="8976d-293">Isso faz com que o GridView repetir a consulta de seus dados, mas os dados devem ser encontrados no cache desde o `Products` tabela de banco de dados não tiver sido modificada.</span><span class="sxs-lookup"><span data-stu-id="8976d-293">This causes the GridView to requery its data, but the data should be found in the cache since the `Products` database table has not been modified.</span></span> <span data-ttu-id="8976d-294">Se os dados repetidamente não for encontrados no cache, verifique se há memória suficiente disponível no seu computador e tente novamente.</span><span class="sxs-lookup"><span data-stu-id="8976d-294">If the data is repeatedly not found in the cache, make sure there is sufficient memory available on your computer and try again.</span></span>

<span data-ttu-id="8976d-295">Após a paginação por meio de algumas páginas de GridView, abra uma segunda janela do navegador e navegue até o tutorial de conceitos básicos de edição, inserção e exclusão de seção (`~/EditInsertDelete/Basics.aspx`).</span><span class="sxs-lookup"><span data-stu-id="8976d-295">After paging through a few pages of the GridView, open a second browser window and navigate to the Basics tutorial in the Editing, Inserting, and Deleting section (`~/EditInsertDelete/Basics.aspx`).</span></span> <span data-ttu-id="8976d-296">Atualizar um registro da tabela Products e em seguida, na primeira janela de navegador, exibir uma nova página ou clicar em um dos cabeçalhos de classificação.</span><span class="sxs-lookup"><span data-stu-id="8976d-296">Update a record from the Products table and then, from the first browser window, view a new page or click on one of the sorting headers.</span></span>

<span data-ttu-id="8976d-297">Neste cenário você verá uma das duas coisas: o ponto de interrupção será atingido, indicando que os dados em cache foi removidos devido à alteração no banco de dados; ou, o ponto de interrupção não será atingido, o que significa que `SqlCacheDependencies.aspx` está mostrando dados obsoletos.</span><span class="sxs-lookup"><span data-stu-id="8976d-297">In this scenario you will see one of two things: either the breakpoint will be hit, indicating that the cached data was evicted due to the change in the database; or, the breakpoint will not be hit, meaning that `SqlCacheDependencies.aspx` is now showing stale data.</span></span> <span data-ttu-id="8976d-298">Se o ponto de interrupção não for atingido, provavelmente porque o serviço de sondagem ainda não foi disparado desde que os dados foi alterados.</span><span class="sxs-lookup"><span data-stu-id="8976d-298">If the breakpoint is not hit, it is likely because the polling service has not yet fired since the data was changed.</span></span> <span data-ttu-id="8976d-299">Lembre-se de que o serviço de sondagem está verificando se há alterações para o `Products` tabela cada `pollTime` milissegundos, portanto, não há um atraso entre quando os dados subjacentes são atualizados e quando os dados em cache seja removidos.</span><span class="sxs-lookup"><span data-stu-id="8976d-299">Remember that the polling service is checking for changes to the `Products` table every `pollTime` milliseconds, so there is a delay between when the underlying data is updated and when the cached data is evicted.</span></span>

> [!NOTE]
> <span data-ttu-id="8976d-300">Esse atraso é mais provável apareçam ao editar um dos produtos por meio de GridView no `SqlCacheDependencies.aspx`.</span><span class="sxs-lookup"><span data-stu-id="8976d-300">This delay is more likely to appear when editing one of the products through the GridView in `SqlCacheDependencies.aspx`.</span></span> <span data-ttu-id="8976d-301">No [dados em cache na arquitetura](caching-data-in-the-architecture-cs.md) tutorial, adicionamos o `MasterCacheKeyArray` dependência para garantir que os dados que está sendo editados por meio de cache a `ProductsCL` classe s `UpdateProduct` método foi removido do cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-301">In the [Caching Data in the Architecture](caching-data-in-the-architecture-cs.md) tutorial we added the `MasterCacheKeyArray` cache dependency to ensure that the data being edited through the `ProductsCL` class s `UpdateProduct` method was evicted from the cache.</span></span> <span data-ttu-id="8976d-302">No entanto, isso foi substituído a dependência de cache ao modificar o `AddCacheItem` método no início desta etapa e, portanto, o `ProductsCL` classe continuará mostrar os dados em cache até que o sistema de sondagem observa a alteração para o `Products` tabela.</span><span class="sxs-lookup"><span data-stu-id="8976d-302">However, we replaced this cache dependency when modifying the `AddCacheItem` method earlier in this step and therefore the `ProductsCL` class will continue to show the cached data until the polling system notes the change to the `Products` table.</span></span> <span data-ttu-id="8976d-303">Veremos como reintroduzir a `MasterCacheKeyArray` a dependência na etapa 7 de cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-303">We'll see how to reintroduce the `MasterCacheKeyArray` cache dependency in Step 7.</span></span>


## <a name="step-7-associating-multiple-dependencies-with-a-cached-item"></a><span data-ttu-id="8976d-304">Etapa 7: Associando várias dependências um Item em cache</span><span class="sxs-lookup"><span data-stu-id="8976d-304">Step 7: Associating Multiple Dependencies with a Cached Item</span></span>

<span data-ttu-id="8976d-305">Lembre-se de que o `MasterCacheKeyArray` dependência de cache é usada para garantir que *todos os* dados relacionados ao produto são removidos do cache quando qualquer outro item associado a ele é atualizado.</span><span class="sxs-lookup"><span data-stu-id="8976d-305">Recall that the `MasterCacheKeyArray` cache dependency is used to ensure that *all* product-related data is evicted from the cache when any single item associated within it is updated.</span></span> <span data-ttu-id="8976d-306">Por exemplo, o `GetProductsByCategoryID(categoryID)` método caches `ProductsDataTables` instâncias para cada exclusivo *categoryID* valor.</span><span class="sxs-lookup"><span data-stu-id="8976d-306">For example, the `GetProductsByCategoryID(categoryID)` method caches `ProductsDataTables` instances for each unique *categoryID* value.</span></span> <span data-ttu-id="8976d-307">Se um desses objetos for removido, o `MasterCacheKeyArray` dependência de cache garante que os outros também serão removidos.</span><span class="sxs-lookup"><span data-stu-id="8976d-307">If one of these objects is evicted, the `MasterCacheKeyArray` cache dependency ensures that the others are also removed.</span></span> <span data-ttu-id="8976d-308">Sem essa dependência de cache, quando os dados armazenados em cache são modificados existe a possibilidade que outros dados de produto em cache podem estar desatualizados.</span><span class="sxs-lookup"><span data-stu-id="8976d-308">Without this cache dependency, when the cached data is modified the possibility exists that other cached product data may be out of date.</span></span> <span data-ttu-id="8976d-309">Consequentemente, ele importante que podemos manter a `MasterCacheKeyArray` a dependência de cache ao usar dependências de cache SQL.</span><span class="sxs-lookup"><span data-stu-id="8976d-309">Consequently, it s important that we maintain the `MasterCacheKeyArray` cache dependency when using SQL cache dependencies.</span></span> <span data-ttu-id="8976d-310">No entanto, os dados de cache s `Insert` método permite apenas para um objeto de dependência única.</span><span class="sxs-lookup"><span data-stu-id="8976d-310">However, the data cache s `Insert` method only allows for a single dependency object.</span></span>

<span data-ttu-id="8976d-311">Além disso, ao trabalhar com dependências de cache SQL é necessário associar várias tabelas de banco de dados como dependências.</span><span class="sxs-lookup"><span data-stu-id="8976d-311">Furthermore, when working with SQL cache dependencies we may need to associate multiple database tables as dependencies.</span></span> <span data-ttu-id="8976d-312">Por exemplo, o `ProductsDataTable` armazenado em cache na `ProductsCL` classe contém os nomes de categoria e fornecedor para cada produto, mas o `AddCacheItem` método usa apenas uma dependência no `Products`.</span><span class="sxs-lookup"><span data-stu-id="8976d-312">For example, the `ProductsDataTable` cached in the `ProductsCL` class contains the category and supplier names for each product, but the `AddCacheItem` method only uses a dependency on `Products`.</span></span> <span data-ttu-id="8976d-313">Nessa situação, se o usuário atualiza o nome de uma categoria ou o fornecedor, os dados do produto armazenada em cache serão permanecem no cache e estar desatualizados.</span><span class="sxs-lookup"><span data-stu-id="8976d-313">In this situation, if the user updates the name of a category or supplier, the cached product data will remain in the cache and be out of date.</span></span> <span data-ttu-id="8976d-314">Portanto, queremos tornar os dados do produto armazenada em cache depende não apenas o `Products` de tabela, mas na `Categories` e `Suppliers` tabelas também.</span><span class="sxs-lookup"><span data-stu-id="8976d-314">Therefore, we want to make the cached product data dependent on not only the `Products` table, but on the `Categories` and `Suppliers` tables as well.</span></span>

<span data-ttu-id="8976d-315">O [ `AggregateCacheDependency` classe](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) fornece um meio para associar várias dependências de um item de cache.</span><span class="sxs-lookup"><span data-stu-id="8976d-315">The [`AggregateCacheDependency` class](https://msdn.microsoft.com/library/system.web.caching.aggregatecachedependency.aspx) provides a means for associating multiple dependencies with a cache item.</span></span> <span data-ttu-id="8976d-316">Comece criando um `AggregateCacheDependency` instância.</span><span class="sxs-lookup"><span data-stu-id="8976d-316">Start by creating an `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="8976d-317">Em seguida, adicione o conjunto de dependências usando o `AggregateCacheDependency` s `Add` método.</span><span class="sxs-lookup"><span data-stu-id="8976d-317">Next, add the set of dependencies using the `AggregateCacheDependency` s `Add` method.</span></span> <span data-ttu-id="8976d-318">Ao inserir o item em cache de dados depois disso, passe o `AggregateCacheDependency` instância.</span><span class="sxs-lookup"><span data-stu-id="8976d-318">When inserting the item into the data cache thereafter, pass in the `AggregateCacheDependency` instance.</span></span> <span data-ttu-id="8976d-319">Quando *qualquer* da `AggregateCacheDependency` alterar de dependências de instância s, o item em cache será removido.</span><span class="sxs-lookup"><span data-stu-id="8976d-319">When *any* of the `AggregateCacheDependency` instance s dependencies change, the cached item will be evicted.</span></span>

<span data-ttu-id="8976d-320">A seguir mostra o código atualizado para o `ProductsCL` classe s `AddCacheItem` método.</span><span class="sxs-lookup"><span data-stu-id="8976d-320">The following shows the updated code for the `ProductsCL` class s `AddCacheItem` method.</span></span> <span data-ttu-id="8976d-321">O método cria o `MasterCacheKeyArray` dependência de cache junto com `SqlCacheDependency` objetos para o `Products`, `Categories`, e `Suppliers` tabelas.</span><span class="sxs-lookup"><span data-stu-id="8976d-321">The method creates the `MasterCacheKeyArray` cache dependency along with `SqlCacheDependency` objects for the `Products`, `Categories`, and `Suppliers` tables.</span></span> <span data-ttu-id="8976d-322">Eles são combinados em uma `AggregateCacheDependency` objeto nomeado `aggregateDependencies`, que é então passado para o `Insert` método.</span><span class="sxs-lookup"><span data-stu-id="8976d-322">These are all combined into one `AggregateCacheDependency` object named `aggregateDependencies`, which is then passed into the `Insert` method.</span></span>


[!code-csharp[Main](using-sql-cache-dependencies-cs/samples/sample15.cs)]

<span data-ttu-id="8976d-323">Teste esse código novo limite. Agora muda para o `Products`, `Categories`, ou `Suppliers` tabelas fazem com que os dados em cache a ser removido.</span><span class="sxs-lookup"><span data-stu-id="8976d-323">Test this new code out. Now changes to the `Products`, `Categories`, or `Suppliers` tables cause the cached data to be evicted.</span></span> <span data-ttu-id="8976d-324">Além disso, o `ProductsCL` classe s `UpdateProduct` método, que é chamado durante a edição de um produto por meio de GridView, remove as `MasterCacheKeyArray` dependência, o que faz com que o cache de cache `ProductsDataTable` a ser removido e os dados a ser recuperado novamente na próxima solicitação.</span><span class="sxs-lookup"><span data-stu-id="8976d-324">Moreover, the `ProductsCL` class s `UpdateProduct` method, which is called when editing a product through the GridView, evicts the `MasterCacheKeyArray` cache dependency, which causes the cached `ProductsDataTable` to be evicted and the data to be re-retrieved on the next request.</span></span>

> [!NOTE]
> <span data-ttu-id="8976d-325">Dependências de cache SQL também podem ser usadas com [cache de saída](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx).</span><span class="sxs-lookup"><span data-stu-id="8976d-325">SQL cache dependencies can also be used with [output caching](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/caching/output.aspx).</span></span> <span data-ttu-id="8976d-326">Para ver uma demonstração dessa funcionalidade, consulte: [usando o cache de saída do ASP.NET com o SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).</span><span class="sxs-lookup"><span data-stu-id="8976d-326">For a demonstration of this functionality, see: [Using ASP.NET Output Caching with SQL Server](https://msdn.microsoft.com/library/e3w8402y(VS.80).aspx).</span></span>


## <a name="summary"></a><span data-ttu-id="8976d-327">Resumo</span><span class="sxs-lookup"><span data-stu-id="8976d-327">Summary</span></span>

<span data-ttu-id="8976d-328">Ao armazenar em cache de banco de dados, os dados idealmente permanecerão no cache até que ele seja modificado no banco de dados.</span><span class="sxs-lookup"><span data-stu-id="8976d-328">When caching database data, the data will ideally remain in the cache until it is modified in the database.</span></span> <span data-ttu-id="8976d-329">Com o ASP.NET 2.0, as dependências de cache do SQL podem ser criadas e usadas em cenários programáticos e declarativos.</span><span class="sxs-lookup"><span data-stu-id="8976d-329">With ASP.NET 2.0, SQL cache dependencies can be created and used in both declarative and programmatic scenarios.</span></span> <span data-ttu-id="8976d-330">Um dos desafios dessa abordagem é em descobrir quando os dados foram modificados.</span><span class="sxs-lookup"><span data-stu-id="8976d-330">One of the challenges with this approach is in discovering when the data has been modified.</span></span> <span data-ttu-id="8976d-331">As versões completas do Microsoft SQL Server 2005 fornecem recursos de notificação que podem alertar um aplicativo quando um resultado de consulta foi alterada.</span><span class="sxs-lookup"><span data-stu-id="8976d-331">The full versions of Microsoft SQL Server 2005 provide notification capabilities that can alert an application when a query result has changed.</span></span> <span data-ttu-id="8976d-332">Para o Express Edition do SQL Server 2005 e versões mais antigas do SQL Server, um sistema de pesquisa deve ser usado em vez disso.</span><span class="sxs-lookup"><span data-stu-id="8976d-332">For the Express Edition of SQL Server 2005 and older versions of SQL Server, a polling system must be used instead.</span></span> <span data-ttu-id="8976d-333">Felizmente, configurando a infraestrutura necessária sondagem é bastante simples.</span><span class="sxs-lookup"><span data-stu-id="8976d-333">Fortunately, setting up the necessary polling infrastructure is fairly straightforward.</span></span>

<span data-ttu-id="8976d-334">Boa programação!</span><span class="sxs-lookup"><span data-stu-id="8976d-334">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="8976d-335">Leitura adicional</span><span class="sxs-lookup"><span data-stu-id="8976d-335">Further Reading</span></span>

<span data-ttu-id="8976d-336">Para obter mais informações sobre os tópicos abordados neste tutorial, consulte os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="8976d-336">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="8976d-337">Usando notificações de consulta no Microsoft SQL Server 2005</span><span class="sxs-lookup"><span data-stu-id="8976d-337">Using Query Notifications in Microsoft SQL Server 2005</span></span>](https://msdn.microsoft.com/library/ms175110.aspx)
- [<span data-ttu-id="8976d-338">Criando uma notificação de consulta</span><span class="sxs-lookup"><span data-stu-id="8976d-338">Creating a Query Notification</span></span>](https://msdn.microsoft.com/library/ms188669.aspx)
- <span data-ttu-id="8976d-339">[Armazenamento em cache no ASP.NET com o `SqlCacheDependency` classe](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="8976d-339">[Caching in ASP.NET with the `SqlCacheDependency` Class](https://msdn.microsoft.com/library/ms178604(VS.80).aspx)</span></span>
- <span data-ttu-id="8976d-340">[Ferramenta de registro do servidor SQL do ASP.NET (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="8976d-340">[ASP.NET SQL Server Registration Tool (`aspnet_regsql.exe`)](https://msdn.microsoft.com/library/ms229862(vs.80).aspx)</span></span>
- [<span data-ttu-id="8976d-341">Visão geral do `SqlCacheDependency`</span><span class="sxs-lookup"><span data-stu-id="8976d-341">Overview of `SqlCacheDependency`</span></span>](http://www.aspnetresources.com/blog/sql_cache_depedency_overview.aspx)

## <a name="about-the-author"></a><span data-ttu-id="8976d-342">Sobre o autor</span><span class="sxs-lookup"><span data-stu-id="8976d-342">About the Author</span></span>

<span data-ttu-id="8976d-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor de sete livros sobre ASP/ASP.NET e fundador da [4GuysFromRolla.com](http://www.4guysfromrolla.com), tem trabalhado com tecnologias Microsoft Web desde 1998.</span><span class="sxs-lookup"><span data-stu-id="8976d-343">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="8976d-344">Scott funciona como um consultor independente, instrutor e escritor.</span><span class="sxs-lookup"><span data-stu-id="8976d-344">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="8976d-345">Seu livro mais recente é [ *Sams Teach por conta própria ASP.NET 2.0 em 24 horas*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="8976d-345">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="8976d-346">Ele pode ser contatado pelo [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="8976d-346">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="8976d-347">ou por meio de seu blog, que pode ser encontrado em [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="8976d-347">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="8976d-348">Agradecimentos especiais a</span><span class="sxs-lookup"><span data-stu-id="8976d-348">Special Thanks To</span></span>

<span data-ttu-id="8976d-349">Esta série de tutoriais foi revisada por muitos revisores úteis.</span><span class="sxs-lookup"><span data-stu-id="8976d-349">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="8976d-350">Revisores líder para este tutorial foram Marko Rangel Teresa Murphy e Hilton Giesenow.</span><span class="sxs-lookup"><span data-stu-id="8976d-350">Lead reviewers for this tutorial were Marko Rangel, Teresa Murphy, and Hilton Giesenow.</span></span> <span data-ttu-id="8976d-351">Você está interessado na revisão Meus próximos artigos do MSDN?</span><span class="sxs-lookup"><span data-stu-id="8976d-351">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="8976d-352">Nesse caso, me descartar uma linha na [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="8976d-352">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="8976d-353">[Anterior](caching-data-at-application-startup-cs.md)
> [Próximo](caching-data-with-the-objectdatasource-vb.md)</span><span class="sxs-lookup"><span data-stu-id="8976d-353">[Previous](caching-data-at-application-startup-cs.md)
[Next](caching-data-with-the-objectdatasource-vb.md)</span></span>
